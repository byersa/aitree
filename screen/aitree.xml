<?xml version="1.0" encoding="UTF-8"?>
<screen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
        xsi:noNamespaceSchemaLocation="component://moqui-ai/xsd/moqui-ai-screen.xsd"
        require-authentication="anonymous-all" screen-theme-type-enum-id="STT_INTERNAL_QUASAR2" allow-extra-path="true"
        default-menu-title="Staff Meeting" default-menu-index="1">

    <pre-actions>
        <script location="component://aitree/script/AitreePreActions.groovy"/>
    </pre-actions>

    <always-actions>
        <set field="appRoot" value="aitree"/>
        <set field="appRootPath" value="/aitree"/>
        <set field="linkBasePath" value="/aitree"/>
        <set field="basePath" value="/aitree"/>
    </always-actions>

    <transition name="getAgendaContainers" read-only="true" require-session-token="false">
        <actions>
            <script>
                def abstracts = ec.entity.find("aitree.meeting.AgendaContainer")
                    .condition("containerTypeEnumId", "AitContainerAbstract")
                    .disableAuthz().list()
                
                def result = [
                    [
                        label: "Active Sessions",
                        type: "group",
                        children: abstracts.collect { 
                            [label: it.name, value: it.agendaContainerId, target: "ActiveMeetings", param: "activeAgendaContainerId"] 
                        }
                    ],
                    [
                        label: "Meeting History",
                        type: "group",
                        children: abstracts.collect { 
                            [label: it.name, value: it.agendaContainerId, target: "MeetingHistory", param: "agendaContainerId"] 
                        }
                    ]
                ]
                ec.web.sendJsonResponse(result)
            </script>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="menuDataQvt2" read-only="true" begin-transaction="false" require-session-token="false">
        <actions><script><![CDATA[
            List<String> fullPath = new ArrayList<>(sri.getActiveScreenPath())
            fullPath.addAll(sri.screenUrlInfo.extraPathNameList)
            // ec.logger.warn("menuDataQvt2 transition hit! root: " + sri.getRootScreenDef().getLocation() + " | fullPath: " + fullPath)
            List menuDataList = sri.getMenuData(fullPath, "", "", false)
            if (menuDataList != null) ec.web.sendJsonResponse(menuDataList)
        ]]></script></actions>
        <default-response type="none" save-parameters="true"/>
    </transition>

    <transition name="moquiaiJs" read-only="true" require-session-token="false">
        <actions>
            <script><![CDATA[
                def path = sri.screenUrlInfo.extraPathNameList.join("/")
                ec.web.sendResourceResponse("component://moqui-ai/screen/moquiai/js/" + path)
            ]]></script>
        </actions>
        <default-response type="none"/>
    </transition>

    <transition name="routes.js" read-only="true">
        <actions>
            <set field="rootScreenLocation" value="component://aitree/screen/aitree.xml"/>
            <set field="rootScreenDef" from="ec.screen.getScreenDefinition(rootScreenLocation)"/>
            <set field="realPathList" from="sri.screenUrlInfo.fullPathNameList"/>
            <set field="realPath" value="/${realPathList.join('/')}"/>
            <script><![CDATA[
                def getSubscreenPaths (org.moqui.impl.screen.ScreenDefinition currentScreenDefinition,List<String> pathList,String basePath) {
                    def subscreenList = currentScreenDefinition?.getSubscreensItemsSorted()
                    for (subscreen in subscreenList) {
                        if (subscreen.location == null) { continue }
                        try {
                            subscreenDefinition = ec.screen.getScreenDefinition(subscreen.location)
                            String currentPath = (basePath == '/' ? '/' : basePath + '/') + currentScreenDefinition.getScreenName()
                            pathList = getSubscreenPaths(subscreenDefinition, pathList, currentPath)
                        } catch (Exception e) {
                            ec.logger.warn("Skipping broken screen definition during routes.js generation: " + subscreen.location)
                        }
                    }
                    String leafPath = (basePath == '/' ? '/' : basePath + '/') + currentScreenDefinition.getScreenName()
                    return pathList + [leafPath]
                }

                pathNameList = getSubscreenPaths(rootScreenDef, [], '/')
                pathList = []
                for (pathName in pathNameList) {
                    String cleanPath = pathName
                    if (cleanPath.startsWith("/aitree")) cleanPath = cleanPath.substring(7)
                    if (!cleanPath.startsWith("/")) cleanPath = "/" + cleanPath
                    pathList.add([path: cleanPath, component: ''])
                }

                template = ec.resource.template('component://moqui-ai/template/screen/routes.js.ftl', '.ftl')
                ec.web.sendTextResponse(template, "application/javascript", "routes.js")
            ]]></script>
        </actions>
        <default-response type="none"/>
    </transition>

    <subscreens default-item="Home">
        <subscreens-item name="Home" location="component://aitree/screen/aitree/Home.xml"/>
        <subscreens-item name="PeopleOrgs" location="component://aitree/screen/aitree/PeopleOrgs.xml"/>
        <subscreens-item name="MedicalRecords" location="component://aitree/screen/aitree/MedicalRecords.xml"/>
        <subscreens-item name="ActiveMeetings" location="component://aitree/screen/aitree/ActiveMeetings.xml" menu-include="false"/>
        <subscreens-item name="MeetingHistory" location="component://aitree/screen/aitree/MeetingHistory.xml" menu-include="false"/>
    </subscreens>

    <widgets>
        <render-mode>
            <text type="html,qvt2" location="component://moqui-ai/template/spa/MoquiAiVue.qvt2.ftl"/>
        </render-mode>

        <container id="apps-root">
            <screen-layout view="hHh lpR fFf" class="bg-grey-1">
                <screen-header elevated="true" class="bg-primary text-white">
                    <screen-toolbar>
                        <render-mode><text type="html,qvt2"><![CDATA[<q-btn :dense="true" :flat="true" :round="true" icon="menu" aria-label="Menu" @click="leftOpen = !leftOpen"></q-btn>]]></text></render-mode>
                        <label text="Staff Meeting" style="q-toolbar-title"/>
                        <container type="q-space"/>
                        <menu-item name="Home"/>
                        <menu-item name="PeopleOrgs"/>
                        <menu-item name="MedicalRecords"/>
                        <menu-dropdown text="Meetings" icon="groups" transition="getAgendaContainers" label-field="label" key-field="value" target-url="ActiveMeetings" url-parameter="activeAgendaContainerId"/>
                    </screen-toolbar>
                </screen-header>

                <screen-content class="q-pa-md">
                    <subscreens-active></subscreens-active>
                </screen-content>
            </screen-layout>
        </container>
    </widgets>
</screen>
